<!DOCTYPE html>
<html lang="pt">
<%- include('../partials/head'); %>

    <body class="wrapper">
        <%- include('../partials/nav'); %>
            <div class="content-layout">
                <%- include('../partials/header', {"page": "Nova venda" }); %>
                    <div style="display:flex; flex-direction: row;">
                        <table class="standard-table" style="width: 30%">
                            <tr>
                                <th>
                                    ID
                                </th>
                                <th>
                                    Descrição
                                </th>
                                <th>
                                    Preço
                                </th>
                                <th width="40">

                                </th>
                            </tr>
                            <% for(let product of products) { %>
                                <tr id="row<%= product.id %>">
                                    <td>
                                        <%= product.id %>
                                    </td>
                                    <td>
                                        <%= product.descricao %>
                                    </td>
                                    <td>
                                        <input type="number" value="<%= product.valor %>" min="0" max="10000" step=".01" class="invisible-field price-field" id="<%= product.id %>">
                                    </td>
                                    <td>
                                        <button class="table-button button-red remove-item" data-product="<%= JSON.stringify(product) %>">✗</button>
                                    </td>
                                </tr>
                            <% } %>
                        </table>
                        <div style="min-height: 20vh; width: 55%; padding: 30; position:relative;" class="light-bordered-container">
                            <h2>&nbsp;&nbsp;&nbsp;&nbsp;Informações do cliente</h2>
                            <div style="position:absolute; top: 60px; left:25px;">
                                <label for="cpf-input">CPF:</label><br>
                                <input type="number" id="cpf-input">
                            </div>
                            <a id="new-venda-link"><button class="pretty-button" style="position:absolute; bottom: 20px; left:25px;">Realizar venda</button></a>
                        </div>
                    </div>
            </div>

            <script>
                let cpfInput = document.getElementById("cpf-input");
                cpfInput.addEventListener('change', (e) => updateLink());
                cpfInput.addEventListener('input', (e) => updateLink());
                cpfInput.addEventListener('keydown', (e) => updateLink());
                cpfInput.addEventListener('paste', (e) => updateLink());

                var selectedItems = JSON.parse(localStorage.getItem('selectedProduct'));
                const buttons = document.getElementsByClassName("remove-item");

                for (let button of buttons) {
                    let product = JSON.parse(button.dataset.product);
                    let id = product.id;

                    console.log("configurou!")

                    button.addEventListener('click', (event) => {
                        if (selectedItems.some(p => p.id == id)) {
                            const index = selectedItems.findIndex(p => p.id == id);
                            selectedItems.splice(index, 1);
                            localStorage.setItem("selectedProduct", JSON.stringify(selectedItems));
                            updateLink();
                        }

                        let linhaDaTabela = document.getElementById("row" + id);
                        linhaDaTabela.style = 'visibility: collapse;';
                    });
                }

                const priceInputs = document.getElementsByClassName('price-field');

                for (let i of priceInputs) {
                    i.addEventListener('change', (e) => updatePrice(i.id, i.value));
                    i.addEventListener('input', (e) => updatePrice(i.id, i.value));
                    i.addEventListener('keydown', (e) => updatePrice(i.id, i.value));
                    i.addEventListener('paste', (e) => updatePrice(i.id, i.value));
                }

                function updatePrice(id, price) {
                    let s = JSON.parse(localStorage.getItem('selectedProduct'));
                    let item = s.find(p => p.id == id);
                    item.valor = price;
                    localStorage.setItem("selectedProduct", JSON.stringify(s));
                }

                updateLink();

                function updateLink() {
                    let a = document.getElementById("new-venda-link");
                    let link = "/products/new?cpfCliente=" + document.getElementById("cpf-input").value
                        + "&selectedProducts=" + JSON.stringify(selectedItems);
                    a.href = link;
                    console.log(a.href);
                }
            </script>
    </body>

</html>